Yesterday, we had hard time to logging inside my webhook handler.
This is what I did:

cd /path/to/my-worker
node server.js
OK

Stripe key loaded: true
âœ… Server running on port 3000
OK

stripe listen --forward-to localhost:3000/webhook
$ stripe listen --forward-to localhost:3000/webhook 
> Ready! You are using Stripe API Version [2025-12-15.clover]. Your webhook signing secret is wh(...)
> Press Ctrl+C to quit



Tab 1 â†’  server terminal will now show:
Stripe key loaded: true
âœ… Server running on port 3000


Then you said:
Ah! I see exactly whatâ€™s happening. Thank you for sharing your `server.js` â€” thereâ€™s one subtle reason why **nothing appears in Terminal Tab 1** when you run `stripe trigger checkout.session.completed`:

---

### The issue

Stripe CLI **sends webhooks only to the endpoint you tell it**. Right now, your server is running on:

```
http://localhost:3000/webhook
```

But from your previous messages, it looks like you **did not start the Stripe CLI listener** with forwarding yet, or it may still be running on a different port.

`stripe trigger` does **not automatically send webhooks to localhost unless you run `stripe listen`**.

So if you just did:

```bash
stripe trigger checkout.session.completed
```

without first doing:

```bash
stripe listen --forward-to localhost:3000/webhook
```

â€¦then **Tab 1 never receives anything**, because no webhooks are being forwarded.

---

### âœ… Correct sequence

1. **Tab 1** â†’ start your server:

```bash
cd /path/to/my-worker
node server.js
```

You should see:

```
Stripe key loaded: true
âœ… Server running on port 3000
```

---

2. **Tab 2** â†’ start Stripe webhook listener:

```bash
stripe listen --forward-to localhost:3000/webhook
```

Youâ€™ll see output like:

```
> Ready! Forwarding webhook events to localhost:3000/webhook
> Press Ctrl+C to quit
```

Keep this terminal open â€” this is **the pipe that delivers events** to your server.

---

3. **Tab 3** â†’ trigger test event:

```bash
stripe trigger checkout.session.completed
```

---

4. **Tab 1** â†’ your server terminal will now show:

```
âœ… Stripe event received: checkout.session.completed
Event data object: { ... }
ðŸŽ‰ Payment success for email: test@example.com
```

---

ðŸ’¡ Important:

* `stripe trigger` only works if **a listener is running and forwarding**.
* Tab 1 is your server. Tab 2 is Stripe CLI listener. Tab 3 is triggering events.

----------------

We also went true:
### How to debug

1. **Check Stripe CLI listener logs** (Tab 2).
   When you run `stripe trigger checkout.session.completed`, the listener (Tab 2) should print something like:

```
> Sending event: checkout.session.completed to http://localhost:3000/webhook
```

If you **donâ€™t see this**, the webhook is not being forwarded to your server.

---

2. **Confirm your server endpoint is reachable**:

In a new terminal, run:

```bash
curl -i http://localhost:3000/webhook
```

* You should get **400 or 200** (likely 400 because the signature is missing).
* If you get `connection refused`, then Stripe CLI cannot reach your server.

---

3. **Ensure `stripe login` has been done in this terminal session**:

```bash
stripe login
```

* This authenticates the Stripe CLI to your account.
* Only after logging in can `stripe listen` actually forward events to your server.

---

4. **Trigger again**:

```bash
stripe trigger checkout.session.completed
```

* Check **Tab 1** â€” server logs should now show the event.

----------------
Dispite How to fix / check

1. **Stop any existing Node processes** on port 3000:

```bash
sudo lsof -i :3000
```

* If it lists a PID, kill it:

```bash
sudo kill -9 <PID>
```

2. **Start the server and make sure it stays running**:

```bash
cd /path/to/my-worker
node server.js
```

* Leave this terminal **open and running**.
* You should see **both**:

```
Stripe key loaded: true
âœ… Server running on port 3000
```

and **the process does not exit**.

3. In a **new terminal**, test connection:

```bash
curl -i http://localhost:3000/health
```

You should see:

```
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
Content-Length: 15
Date: Thu, 15 Jan 2026 12:34:56 GMT
Connection: keep-alive

{"status":"ok"}
```

* If this works, it confirms your server is **reachable**.

---

4. Now, in another terminal, start Stripe CLI:

```bash
stripe listen --forward-to localhost:3000/webhook
```

5. Trigger test event:

```bash
stripe trigger checkout.session.completed
```

* Your **server terminal** should now log the event.

---

ðŸ’¡ Key point: The reason your previous `curl` failed is **the server wasnâ€™t actually listening when you tried it**, so Stripe CLI couldnâ€™t deliver the webhook either.

----------------
Then, I posted my server.js for checking
and you said:
Your server.js looks perfectly set up for receiving Stripe webhooks. âœ…

Hereâ€™s a breakdown:

âœ… Whatâ€™s correct

dotenv is loaded before using any environment variables.

Express app is initialized properly.

Stripe is instantiated with process.env.STRIPE_SECRET_KEY.

Webhook endpoint /webhook uses express.raw({ type: "application/json" }), which is required by Stripe.

Webhook signature verification is correctly implemented with stripe.webhooks.constructEvent.

Event logging is detailed, showing both the event type and full object.

Specific reaction for checkout.session.completed is present â€” logs the customer email.

Health check /health works.

Server listens on the correct port.

ðŸ”¹ Whatâ€™s next

Right now, your webhook only logs events. The next step is to automatically grant entitlement when a checkout session completes. That means:

Reading your data/entitlements.json.

Adding the customer info (customer_id + email).

Writing back to the JSON file.

This is exactly what your test-env.js grantEntitlement() function does.

I can write a drop-in snippet to put inside your webhook so it automatically updates entitlements.json for any completed checkout session.

Do you want me to do that next?


